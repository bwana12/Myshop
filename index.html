<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, onSnapshot, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

// --- FIREBASE CONFIG ---
const firebaseConfig = {
    apiKey: "AIzaSyDwhyU5BrtjRhy-45rd5oYfzGO8abehUiM",
    authDomain: "shopeasy-14890.firebaseapp.com",
    projectId: "shopeasy-14890",
    storageBucket: "shopeasy-14890.firebasestorage.app",
    messagingSenderId: "45827037951",
    appId: "1:45827037951:web:545d41703780fa51018aca"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

let cart = JSON.parse(localStorage.getItem('se_cart_persistent')) || [];
let allItems = [];

window.login = () => signInWithPopup(auth, provider);
window.logout = () => signOut(auth).then(() => location.reload());

// --- AUTH ---
onAuthStateChanged(auth, user => {
    if (user) {
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('main-app').style.display = 'block';
        document.getElementById('user-name').innerText = user.displayName;
        document.getElementById('user-email').innerText = user.email;
        document.getElementById('user-photo').src = user.photoURL;
        updateCartUI();
    }
});

// --- PRODUCTS GRID ---
onSnapshot(collection(db, "products"), (snap) => {
    allItems = [];
    snap.forEach(doc => allItems.push({...doc.data(), id: doc.id}));
    renderGrid(allItems);
});

function renderGrid(products) {
    const container = document.getElementById('products-container');
    container.innerHTML = "";
    products.forEach(p => {
        const fakePrice = Math.floor(p.price * 1.32);
        container.innerHTML += `
            <div class="product-card" onclick="addToCart('${p.name}', ${p.price}, '${p.image}')">
                <div class="flash-tag">âš¡ FLASH DEAL</div>
                <img src="${p.image}" class="product-img">
                <div class="info">
                    <div class="item-name">${p.name}</div>
                    <div class="price-row">
                        <span class="current-price">MK ${p.price.toLocaleString()}</span>
                        <span class="old-price">MK ${fakePrice.toLocaleString()}</span>
                    </div>
                </div>
            </div>`;
    });
}

window.searchProducts = () => {
    const term = document.getElementById('search-input').value.toLowerCase();
    const filtered = allItems.filter(p => p.name.toLowerCase().includes(term));
    renderGrid(filtered);
};

window.addToCart = (name, price, img) => {
    cart.push({name, price, img});
    localStorage.setItem('se_cart_persistent', JSON.stringify(cart));
    updateCartUI();
    alert("Added to Cart!");
};

function updateCartUI() {
    document.getElementById('cart-badge').innerText = cart.length;
    const list = document.getElementById('cart-items-list');
    let total = 0;
    list.innerHTML = "";
    cart.forEach((item) => {
        total += item.price;
        list.innerHTML += `<div style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #eee;">
            <span>${item.name}</span>
            <b>MK ${item.price.toLocaleString()}</b>
        </div>`;
    });
    document.getElementById('cart-total').innerText = "MK " + total.toLocaleString();
}

// --- WHATSAPP CHECKOUT + FIRESTORE LOGGING ---
window.whatsappCheckout = async () => {
    if (!auth.currentUser) return alert("Please login first!");

    const userName = auth.currentUser.displayName;
    const userEmail = auth.currentUser.email;

    // Build WhatsApp message
    let msg = `ðŸ›ï¸ Order from ${userName}:%0A`;
    cart.forEach(i => msg += `- ${i.name} (MK ${i.price.toLocaleString()})%0A`);

    // Save order to Firestore
    try {
        const total = cart.reduce((sum, i) => sum + i.price, 0);
        await addDoc(collection(db, "orders"), {
            customerName: userName,
            customerEmail: userEmail,
            items: cart,
            total,
            timestamp: Date.now(),
            status: "pending"
        });
    } catch(e) {
        console.error("Failed to save order:", e);
    }

    // Open WhatsApp
    window.open(`https://wa.me/265899195843?text=${msg}`);
    
    // Clear cart
    cart = [];
    localStorage.setItem('se_cart_persistent', JSON.stringify(cart));
    updateCartUI();
};
</script>
